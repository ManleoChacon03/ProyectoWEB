<!-- Content Header -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">
          Gestión de Pedidos
        </h1>
      </div>
      <div class="col-sm-6">
        
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          Lista de Pedidos
        </h3>
        <div class="card-badge">
          <span class="badge-info">{{dataSource.data.length}} pedidos</span>
        </div>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table mat-table [dataSource]="dataSource" matSort class="pedidos-table">

            <!-- Columna ID -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Pedido #</th>
              <td mat-cell *matCellDef="let p">
                <span class="pedido-badge">#{{p.id}}</span>
              </td>
            </ng-container>

            <!-- Columna Fecha -->
            <ng-container matColumnDef="fechaCreacion">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Fecha
              </th>
              <td mat-cell *matCellDef="let p">
                {{p.fechaCreacion | date:'dd/MM/yyyy HH:mm'}}
              </td>
            </ng-container>

            <!-- Columna Cliente -->
            <ng-container matColumnDef="clienteNombre">
              <th mat-header-cell *matHeaderCellDef>
                Cliente
              </th>
              <td mat-cell *matCellDef="let p" class="cliente-cell">
                <div class="cliente-info">
                  <div class="cliente-details">
                    <span class="cliente-nombre">
                      {{ p.tipoVenta === 'EnTienda' ? p.clienteNombre : p.usuario?.nombreCompleto }}
                    </span>
                    <span class="tipo-venta"
                          [class.tipo-online]="p.tipoVenta === 'EnLinea'"
                          [class.tipo-tienda]="p.tipoVenta === 'EnTienda'">
                      {{p.tipoVenta === 'EnLinea' ? 'En Línea' : 'En Tienda'}}
                    </span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Columna Total Bruto -->
            <ng-container matColumnDef="montoTotal">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Total Bruto
              </th>
              <td mat-cell *matCellDef="let p" class="monto-cell">
                {{p.montoTotal | currency:'GTQ':'Q'}}
              </td>
            </ng-container>

            <!-- Columna Devuelto -->
            <ng-container matColumnDef="montoDevuelto">
              <th mat-header-cell *matHeaderCellDef>
                Devuelto
              </th>
              <td mat-cell *matCellDef="let p" class="debit-amount">
                <span *ngIf="calcularMontoDevuelto(p) > 0">
                  -{{calcularMontoDevuelto(p) | currency:'GTQ':'Q'}}
                </span>
                <span *ngIf="calcularMontoDevuelto(p) === 0" class="no-devolucion">
                  -
                </span>
              </td>
            </ng-container>

            <!-- Columna Venta Neta -->
            <ng-container matColumnDef="ventaNeta">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Venta Neta
              </th>
              <td mat-cell *matCellDef="let p" class="neta-cell">
                {{calcularVentaNeta(p) | currency:'GTQ':'Q'}}
              </td>
            </ng-container>

            <!-- Columna Estado -->
            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef>
                Estado
              </th>
              <td mat-cell *matCellDef="let pedido">
                <mat-form-field appearance="outline" class="estado-select">
                  <mat-select [value]="pedido.estado"
                              (selectionChange)="cambiarEstado(pedido, $event.value)"
                              [ngClass]="{
                                'estado-pendiente': pedido.estado === 'Pendiente',
                                'estado-procesando': pedido.estado === 'Procesando',
                                'estado-enviado': pedido.estado === 'Enviado',
                                'estado-completado': pedido.estado === 'Completado',
                                'estado-cancelado': pedido.estado === 'Cancelado'
                              }">
                    <mat-option *ngFor="let estado of estadosPosibles" [value]="estado">
                      {{ estado }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>

            <!-- Sin datos -->
            <tr class="mat-row no-data-row" *matNoDataRow>
              <td class="mat-cell" colspan="7">
                <div class="no-data-message">
                  <mat-icon>inbox</mat-icon>
                  <p>No hay pedidos registrados</p>
                </div>
              </td>
            </tr>
          </table>
        </div>

        <!-- Paginador -->
        <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]"
                       [pageSize]="10"
                       showFirstLastButtons>
        </mat-paginator>
      </div>
    </div>

  </div>
</section>
